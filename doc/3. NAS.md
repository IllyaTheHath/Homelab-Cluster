# 自搭建 NAS 配置

### 操作系统选择
NAS 我最终选择了使用 Windows Server 来搭建，原因有几点：
- RDP 方便管理
- NTFS 文件系统
- 自己家的 SMB，速度比其他的不知道高到哪里去了
- 服务器管理器可以十分方便的设置 SMB/NFS/iSCSI 共享
- 十分成熟而且稳定的操作系统
- 买了 MSDN 给的 key 不用白不用

可能有很多人会觉得 Windows 系统不适合做服务器，认为会像 Win10 一样经常崩溃+自动更新。但是作为一个 Windows/.Net 开发程序员，至少在我使用时基本没崩溃过。公司一大批服务也都是用 Windows 或者 Windows Container 部署的。还是要看自己的运维技术 :)

当然我也尝试了基于 BSD 的 TrueNAS，还有 unraid，ovm，TrueNAS Core 这些基于 Linux 的 NAS 系统。  
TrueNAS，使用的是zfs文件系统，需要大容量 ecc 内存支持（再见，我 cpu 不支持）而且我个人十分不喜 ZFS，在家用环境中 ZFS 没有太大的收益，反而大大增加了操作难度。重要数据还是要多重镜像+冷备。

unraid 就是个玩具，不解释，虽然校验做的确实不错。

ovm 还是不错的，可以组软件 RAID，也可以通过 UnionFS 和 SnapRAID 来做条带+校验，但是考虑之后还是选择了 Windows，NTFS 太方便了。

### 文件系统选择
在 Windows Server 上也只有两种选择

1. NTFS
2. REFS

我选择了 NTFS。REFS 是微软 Windows Server 2012上 新推出的文件格式，前几年被 Win10 支持是大家都在讨论，但是后来还是在家用系统中删掉了。在我的理解中 REFS 就是个带校验的 RAID 5，单盘就能做奇偶校验，高科技。而且在数据级别上有更强大的功能，永远不需要做磁盘检查。配合 Windows 的存储池使用更酸爽。

但是缺点也不少，首先最重要的一点，没有数据恢复工具，这也意味着盘坏了数据就全损了，企业和数据中心用 raid 肯定是没问题，但是我是拒绝 raid 的。  
其次是我这几块硬盘有一块是从 PC 上薅下来的，上边已经有了十分多的数据，如果换成 REFS 要花费很长时间去迁移数据，主要是NTFS 和 REFS 不支持合并到一起。

因此我最终选择了 NTFS

### 联合文件系统
Windows 上做联合 FS 的话也有多种方案。
- 硬件 RAID  
  我的 NAS 是有硬件 RAID 卡的，可以做硬件 RAID。但是我也说过了我不喜欢 RAID，于是改成了 HBA 模式。

- Windows 存储池  
  现在改名叫存储空间了。做一个简单的存储池非常方便，UI 上边点一点就 OK 了，RAID 0/1/5 都能够很轻松的做，而且不像 zfs 一样扩容十分麻烦，即插即扩。

  缺点的话，raid 0，条带化导致一块硬盘坏了直接 gg。raid 1，少一半空间，我并不需要这么高的容错率。这两个和 zfs 一样的。raid 5 则是十分的慢，非常慢，尤其是写入.不知道微软做了什么手脚。虽然可以通过加入 SSD 缓存盘来加速写入，但是读取还是慢而且这样要全程 Powershell 操作。

- 跨区卷  
  简单的把每块硬盘都拼接在一起，每块硬盘还可以单独访问文件。但是已经被微软停止支持了，继任者就是存储池。

- 第三方软件
  StableBit DriverPool，Windows 上只有这一个好用的，类似于 Linux 的 UnionFS 和刚刚说的跨区卷。但是要收费，买断制或者订阅。

我选择了用 StableBit DriverPool。

### 数据保护
StableBit DriverPool 自带类似于 raid 1 的重复保护，可以做到指定文件同时向 N 块硬盘写入，N 也可以自定义。我把一些重要数据，比如给集群 share 的共享存储，esxi 使用的共享，数据文件夹，备份文件夹，都做了重复保护。这样就算一块挂了也不会丢失，StableBit DriverPool 会将备份继续复制到还存活的硬盘上。  
同时 StableBit DriverPool 还支持检测硬盘的 Smart 信息及好坏程度，如果有硬盘即将损坏，他会自动将数据转移出去，这点非常棒。  
然后其他非重要数据我是用了 SnapRAID 来做奇偶校验。在校验时排除了已经加了重复保护的数据。然后每过一段时间手动去做一次 sync。不自动 sync 是为了防止硬盘突然挂掉而我还不知道，他自动把数据给 sync 没了。

SnapRAID 配置见此 [配置文件](./../config/nas/snapraid.conf)